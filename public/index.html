<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ£‹ç±»æ¸¸æˆåˆé›†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container { display: flex; gap: 20px; max-width: 1400px; width: 100%; }
    .main-panel {
      background: #f5f0e1;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      flex: 1;
      min-width: 0;
    }
    
    .sidebar {
      width: 280px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-height: 700px;
      overflow-y: auto;
    }
    
    h1 { text-align: center; color: #333; margin-bottom: 20px; }
    h2 { color: #333; margin-bottom: 16px; }
    h3 { color: #555; margin-bottom: 12px; }
    
    .game-select {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .game-card {
      flex: 1;
      padding: 20px;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      border: 3px solid transparent;
    }
    
    .game-card.gomoku {
      background: linear-gradient(135deg, #2d5016 0%, #1a3009 100%);
      color: white;
    }
    
    .game-card.go {
      background: linear-gradient(135deg, #8b7355 0%, #5c4033 100%);
      color: white;
    }
    
    .game-card:hover { transform: translateY(-4px); }
    .game-card.selected { border-color: #ffd700; transform: translateY(-4px); box-shadow: 0 8px 20px rgba(255,215,0,0.3); }
    .game-card .game-icon { font-size: 48px; margin-bottom: 8px; }
    .game-card .game-name { font-size: 18px; font-weight: bold; }
    .game-card .game-desc { font-size: 12px; opacity: 0.8; margin-top: 4px; }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    input[type="text"]:focus { outline: none; border-color: #667eea; }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
    .btn-danger { background: linear-gradient(135deg, #eb3349, #f45c43); color: white; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-pass { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
    
    .color-picker { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
    }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.3); }
    .color-option.disabled { opacity: 0.3; cursor: not-allowed; }
    
    .room-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .room-item:hover { background: #e9ecef; }
    .room-id { font-weight: bold; font-family: monospace; font-size: 16px; color: #667eea; }
    .room-count { color: #666; font-size: 14px; }
    .room-game { font-size: 12px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }
    .room-game.gomoku { background: #2d5016; color: white; }
    .room-game.go { background: #8b7355; color: white; }
    .join-btn-small { padding: 6px 12px; font-size: 12px; background: #667eea; color: white; border: none; border-radius: 4px; }
    
    /* äº”å­æ£‹æ£‹ç›˜ */
    .gomoku-board {
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      gap: 1px;
      background: #8b7355;
      padding: 10px;
      border-radius: 8px;
      margin: 0 auto 20px;
      max-width: 480px;
      aspect-ratio: 1;
    }
    
    /* å›´æ£‹æ£‹ç›˜ */
    .go-board {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 1px;
      background: #dcb35c;
      padding: 10px;
      border-radius: 8px;
      margin: 0 auto 20px;
      max-width: 400px;
      aspect-ratio: 1;
    }
    
    .cell { 
      aspect-ratio: 1; 
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .gomoku-board .cell { background: #dcb35c; }
    .gomoku-board .cell:hover { background: #c9a54a; }
    .go-board .cell { background: #dcb35c; }
    .go-board .cell:hover { background: #c9a54a; }
    
    /* å›´æ£‹æ˜Ÿä½ */
    .go-board .cell.star::before {
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      background: #5c4033;
      border-radius: 50%;
    }
    
    .piece {
      width: 85%;
      height: 85%;
      border-radius: 50%;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.4);
    }
    .piece.black { background: radial-gradient(circle at 30% 30%, #444, #000); }
    .piece.white { background: radial-gradient(circle at 30% 30%, #fff, #ddd); }
    .piece.red { background: radial-gradient(circle at 30% 30%, #ff6b6b, #c00); }
    
    .player-list { background: #f8f9fa; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    
    .player-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }
    .player-item:last-child { border-bottom: none; }
    
    .player-order {
      width: 24px;
      height: 24px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      margin-right: 10px;
    }
    .player-name { flex: 1; font-weight: 600; }
    .player-color { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; }
    .player-score { 
      background: #ffd700; 
      color: #333; 
      padding: 2px 8px; 
      border-radius: 10px; 
      font-size: 12px; 
      font-weight: bold;
      margin-left: 8px;
    }
    
    .turn-indicator {
      text-align: center;
      padding: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: bold;
    }
    .turn-indicator.waiting { background: #6c757d; }
    .turn-indicator.paused { background: #f39c12; }
    
    .score-board {
      display: flex;
      justify-content: space-around;
      margin-bottom: 16px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .score-item {
      text-align: center;
    }
    
    .score-color {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin: 0 auto 4px;
      border: 2px solid #333;
    }
    
    .score-value {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    
    .score-target {
      font-size: 12px;
      color: #666;
    }
    
    .chat-container { height: 200px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .chat-message { margin-bottom: 8px; padding: 8px 12px; border-radius: 8px; background: white; }
    .chat-message.system { background: #e9ecef; color: #666; font-size: 14px; text-align: center; }
    
    .chat-header { font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .chat-color-dot { width: 12px; height: 12px; border-radius: 50%; }
    
    .chat-input { display: flex; gap: 8px; }
    .chat-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    .btn-chat { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content { background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 400px; }
    .modal-content h2 { margin-bottom: 20px; }
    .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
    .modal-buttons .btn { margin-bottom: 0; }
    
    .screen { display: none; }
    .screen.active { display: block; }
    
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .room-id-badge { 
      padding: 8px 16px; 
      border-radius: 8px; 
      font-family: monospace; 
      font-size: 18px; 
      color: white;
    }
    .room-id-badge.gomoku { background: #2d5016; }
    .room-id-badge.go { background: #8b7355; }
    
    .my-piece-info { text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-top: 16px; }
    .my-piece-color { display: inline-block; width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin: 0 8px; border: 2px solid #333; }
    
    .action-buttons { display: flex; gap: 10px; margin-top: 16px; }
    .action-buttons .btn { margin-bottom: 0; flex: 1; }
    
    .pass-btn { 
      background: linear-gradient(135deg, #4facfe, #00f2fe); 
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    .pass-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .winner-badge {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .hidden { display: none !important; }
    
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; max-height: none; }
      .game-select { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-panel">
      <h1>ğŸ® æ£‹ç±»æ¸¸æˆåˆé›†</h1>
      
      <!-- é€‰æ‹©æ¸¸æˆ -->
      <div id="selectScreen" class="screen active">
        <div class="game-select">
          <div class="game-card gomoku selected" onclick="selectGame('gomoku')" id="gomokuCard">
            <div class="game-icon">ğŸ•</div>
            <div class="game-name">å¤šäººäº”å­æ£‹</div>
            <div class="game-desc">15è·¯æ£‹ç›˜ Â· è¿5è·èƒœ</div>
          </div>
          <div class="game-card go" onclick="selectGame('go')" id="goCard">
            <div class="game-icon">âš«</div>
            <div class="game-name">ä¸‰äººå›´æ£‹</div>
            <div class="game-desc">9è·¯æ£‹ç›˜ Â· æå­å¾—åˆ†</div>
          </div>
        </div>
        
        <div class="form-group">
          <label>ä½ çš„æ˜µç§°</label>
          <input type="text" id="playerName" placeholder="è¾“å…¥æ˜µç§°" maxlength="20">
        </div>
        
        <button class="btn btn-success" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
        
        <div style="margin-top: 20px;">
          <h3>æ¸¸æˆè§„åˆ™</h3>
          <div id="gomokuRules" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 12px;">
            <p>â€¢ 2äººå¯¹æˆ˜ï¼Œè½®æµä¸‹æ£‹</p>
            <p>â€¢ å…ˆè¿æˆ5å­è·èƒœ</p>
            <p>â€¢ åƒå­è§„åˆ™ï¼šå‘¨å›´æ— æ°”çš„æ£‹å­è¢«ææ‰</p>
          </div>
          <div id="goRules" class="hidden" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 12px;">
            <p>â€¢ 3äººè½®æµä¸‹æ£‹</p>
            <p>â€¢ å‘¨å›´æ— æ°”çš„æ£‹å­è¢«ææ‰</p>
            <p>â€¢ æå­å¾—1åˆ†ï¼Œå…ˆå¾—20åˆ†è€…è·èƒœ</p>
            <p>â€¢ æ— å¤„è½å­æ—¶å¾—åˆ†å¤šè€…è·èƒœ</p>
          </div>
        </div>
      </div>
      
      <!-- æˆ¿é—´ç­‰å¾… -->
      <div id="roomScreen" class="screen">
        <div class="room-header">
          <span class="room-id-badge" id="roomIdDisplay">ROOM</span>
          <button class="btn btn-warning" onclick="leaveCurrentRoom()" style="width: auto; padding: 8px 16px;">ç¦»å¼€</button>
        </div>
        
        <div class="player-list">
          <h4 style="margin-bottom: 12px;">ç©å®¶åˆ—è¡¨ <span id="playerCount">(0/3)</span></h4>
          <div id="playerList"></div>
        </div>
        
        <div class="rules">
          <h4 style="margin-bottom: 12px;">é€‰æ‹©ä½ çš„æ£‹å­é¢œè‰²</h4>
          <div class="color-picker" id="colorPicker"></div>
        </div>
        
        <button class="btn btn-primary" id="startBtn" onclick="startGame()" style="display:none;">å¼€å§‹æ¸¸æˆ</button>
      </div>
      
      <!-- æ¸¸æˆç•Œé¢ -->
      <div id="gameScreen" class="screen">
        <div class="room-header">
          <span class="room-id-badge" id="gameRoomIdDisplay">ROOM</span>
          <div id="currentTurn" class="turn-indicator waiting">ç­‰å¾…å¼€å§‹...</div>
        </div>
        
        <div class="score-board" id="scoreBoard"></div>
        
        <div id="gomokuBoardContainer">
          <div class="gomoku-board" id="gomokuBoard"></div>
        </div>
        
        <div id="goBoardContainer" class="hidden">
          <div class="go-board" id="goBoard"></div>
        </div>
        
        <div id="myPieceInfo" class="my-piece-info">
          <span>ä½ çš„æ£‹å­ï¼š</span>
          <span id="myPieceColor" class="my-piece-color"></span>
          <span id="myPieceName"></span>
          <span>ï¼ˆå¾—åˆ†ï¼š<span id="myScore">0</span>ï¼‰</span>
        </div>
        
        <button class="pass-btn" id="passBtn" onclick="passTurn()" style="display:none;">åœä¸€æ‰‹</button>
        
        <div class="action-buttons">
          <button class="btn btn-warning" onclick="leaveGameToHome()">è¿”å›ä¸»é¡µ</button>
        </div>
      </div>
    </div>
    
    <div class="sidebar">
      <div id="homeSidebar">
        <h3 style="margin-bottom: 16px;">åŠ å…¥æˆ¿é—´</h3>
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <input type="text" id="joinRoomInput" placeholder="è¾“å…¥æˆ¿é—´å·" maxlength="6" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:16px;text-transform:uppercase;letter-spacing:2px;text-align:center;">
          <button class="btn btn-primary" onclick="joinByInput()" style="width:auto;padding:10px 16px;">åŠ å…¥</button>
        </div>
        
        <h4 style="margin-bottom: 12px;">å…¬å¼€æˆ¿é—´</h4>
        <div id="roomList" class="room-list">
          <div style="text-align:center;color:#999;padding:20px;">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <div id="gameSidebar" style="display:none;">
        <h3 style="margin-bottom: 16px;">èŠå¤©</h3>
        <div class="chat-container" id="chatMessages"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="100" onkeypress="if(event.key==='Enter')sendChat()">
          <button class="btn-chat" onclick="sendChat()">å‘é€</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- è·èƒœå¼¹çª— -->
  <div id="winnerModal" class="modal">
    <div class="modal-content">
      <div class="winner-badge">ğŸ†</div>
      <h2 id="winnerTitle">æ¸¸æˆç»“æŸï¼</h2>
      <div id="winnerInfo"></div>
      <button class="btn btn-success" onclick="closeModal(); restartGame();" style="margin-top:20px;">å†æ¥ä¸€å±€</button>
      <button class="btn btn-warning" onclick="closeModal()">è¿”å›æˆ¿é—´</button>
    </div>
  </div>

  <script>
    const PLAYER_ROLES_GOMOKU = ['é»‘æ£‹', 'ç™½æ£‹'];
    const PLAYER_COLORS_GOMOKU = ['#000000', '#FFFFFF'];
    const PIECE_CLASSES_GOMOKU = ['black', 'white'];
    const BOARD_SIZE_GOMOKU = 15;
    
    const PLAYER_ROLES_GO = ['é»‘æ£‹', 'ç™½æ£‹', 'çº¢æ£‹'];
    const PLAYER_COLORS_GO = ['#000000', '#FFFFFF', '#FF0000'];
    const PIECE_CLASSES_GO = ['black', 'white', 'red'];
    const BOARD_SIZE_GO = 9;
    const WINNING_SCORE_GO = 20;
    
    let ws = null;
    let myOrderId = null;
    let myColorId = null;
    let ownerOrderId = 0;
    let currentRoomId = null;
    let currentGameMode = 'gomoku';
    let gameConfig = null;
    let players = [];
    let currentTurn = null;
    let waitingReconnect = false;
    let pendingOfflineOrderId = null;
    let scores = [];
    
    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(protocol + '//' + window.location.host);
      
      ws.onopen = () => {
        refreshRoomList();
      };
      
      ws.onmessage = (event) => {
        try {
          handleMessage(JSON.parse(event.data));
        } catch (e) {
          console.error('Message parse error:', e);
        }
      };
      
      ws.onclose = () => {
        setTimeout(connect, 3000);
      };
    }
    
    function safeSend(data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data));
      }
    }
    
    function selectGame(mode) {
      currentGameMode = mode;
      document.querySelectorAll('.game-card').forEach(c => c.classList.remove('selected'));
      document.getElementById(mode + 'Card').classList.add('selected');
      document.getElementById('gomokuRules').classList.toggle('hidden', mode !== 'gomoku');
      document.getElementById('goRules').classList.toggle('hidden', mode !== 'go');
    }
    
    function handleMessage(msg) {
      switch (msg.type) {
        case 'created':
        case 'joined':
          currentRoomId = msg.roomId;
          currentGameMode = msg.gameMode;
          gameConfig = msg.config;
          myOrderId = msg.orderId;
          myColorId = msg.colorId;
          ownerOrderId = msg.ownerOrderId ?? 0;
          players = msg.players || [];
          scores = msg.scores || [];
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          localStorage.setItem('gomoku_colorId', msg.colorId);
          switchScreen('roomScreen');
          document.getElementById('roomIdDisplay').textContent = msg.roomId;
          document.getElementById('roomIdDisplay').className = 'room-id-badge ' + currentGameMode;
          document.getElementById('homeSidebar').style.display = 'none';
          document.getElementById('gameSidebar').style.display = 'none';
          clearChat();
          updatePlayerList();
          updateColorPicker();
          updateScoreBoard();
          setTimeout(refreshRoomList, 100);
          break;
          
        case 'playerJoined':
          players = msg.players || [];
          scores = msg.scores || [];
          updatePlayerList();
          updateColorPicker();
          updateScoreBoard();
          break;
          
        case 'playerLeft':
          players = msg.players || [];
          scores = msg.scores || [];
          updatePlayerList();
          updateColorPicker();
          updateScoreBoard();
          addSystemMessage(msg.playerName + ' ç¦»å¼€äº†æˆ¿é—´');
          break;
          
        case 'colorChanged':
          players = msg.players || [];
          updatePlayerList();
          updateColorPicker();
          break;
          
        case 'ownerChanged':
          ownerOrderId = msg.newOwnerOrderId ?? 0;
          addSystemMessage('æ–°æˆ¿ä¸»: ' + msg.newOwnerName);
          updatePlayerList();
          break;
          
        case 'gameStart':
          switchScreen('gameScreen');
          document.getElementById('gameRoomIdDisplay').textContent = currentRoomId;
          document.getElementById('gameRoomIdDisplay').className = 'room-id-badge ' + currentGameMode;
          document.getElementById('homeSidebar').style.display = 'none';
          document.getElementById('gameSidebar').style.display = 'block';
          
          if (currentGameMode === 'gomoku') {
            document.getElementById('gomokuBoardContainer').classList.remove('hidden');
            document.getElementById('goBoardContainer').classList.add('hidden');
            initGomokuBoard();
          } else {
            document.getElementById('gomokuBoardContainer').classList.add('hidden');
            document.getElementById('goBoardContainer').classList.remove('hidden');
            initGoBoard();
          }
          
          currentTurn = msg.currentPlayer;
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          scores = msg.scores || [];
          clearChat();
          players = msg.players || [];
          ownerOrderId = msg.ownerOrderId ?? 0;
          document.getElementById('passBtn').style.display = currentGameMode === 'go' ? 'inline-block' : 'none';
          document.getElementById('passBtn').disabled = false;
          updateGame();
          updatePlayerList();
          updateScoreBoard();
          addSystemMessage(currentGameMode === 'gomoku' ? 'æ¸¸æˆå¼€å§‹ï¼å…ˆè¿5å­è€…è·èƒœï¼' : 'æ¸¸æˆå¼€å§‹ï¼è½®æµä¸‹æ£‹ï¼Œæå­å¾—1åˆ†ï¼Œå…ˆå¾—20åˆ†è€…è·èƒœï¼');
          break;
          
        case 'move':
          placePiece(msg.row, msg.col, msg.colorId);
          
          if (msg.scores) {
            scores = msg.scores;
            updateScoreBoard();
          }
          
          if (msg.captured && msg.captured.length > 0) {
            addSystemMessage('ææ‰ ' + msg.captured.length + ' å­ï¼');
          }
          
          if (msg.gameOver) {
            currentTurn = null;
            document.getElementById('passBtn').style.display = 'none';
            showWinner(msg.orderId);
          } else if (msg.currentPlayer !== undefined) {
            currentTurn = msg.currentPlayer;
            document.getElementById('passBtn').disabled = currentTurn !== myOrderId;
          }
          updateTurn();
          break;
          
        case 'pass':
          addSystemMessage(msg.playerName + ' åœäº†ä¸€æ‰‹');
          if (msg.currentPlayer !== undefined) {
            currentTurn = msg.currentPlayer;
            document.getElementById('passBtn').disabled = currentTurn !== myOrderId;
          }
          updateTurn();
          break;
          
        case 'playerOffline':
          waitingReconnect = true;
          addSystemMessage(msg.playerName + ' ç¦»çº¿äº†');
          updateTurn();
          break;
          
        case 'playerReconnected':
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          players = msg.players || [];
          scores = msg.scores || [];
          ownerOrderId = msg.ownerOrderId ?? 0;
          addSystemMessage(msg.playerName + ' å·²é‡è¿ï¼');
          updatePlayerList();
          updateScoreBoard();
          updateTurn();
          break;
          
        case 'gameResumed':
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          addSystemMessage(msg.message);
          updateTurn();
          break;
          
        case 'playerRemoved':
          waitingReconnect = msg.waitingReconnect ?? false;
          pendingOfflineOrderId = null;
          players = msg.players || [];
          scores = msg.scores || [];
          currentTurn = msg.currentPlayer ?? currentTurn;
          ownerOrderId = msg.ownerOrderId ?? 0;
          addSystemMessage(msg.playerName + ' å·²è¢«ç§»é™¤');
          updatePlayerList();
          updateScoreBoard();
          updateTurn();
          break;
          
        case 'rejoined':
          currentRoomId = msg.roomId;
          currentGameMode = msg.gameMode;
          gameConfig = msg.config;
          myOrderId = msg.orderId;
          myColorId = msg.colorId;
          currentTurn = msg.currentPlayer;
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          scores = msg.scores || [];
          switchScreen('gameScreen');
          document.getElementById('gameRoomIdDisplay').textContent = msg.roomId;
          document.getElementById('gameRoomIdDisplay').className = 'room-id-badge ' + currentGameMode;
          document.getElementById('homeSidebar').style.display = 'none';
          document.getElementById('gameSidebar').style.display = 'block';
          clearChat();
          
          if (currentGameMode === 'gomoku') {
            document.getElementById('gomokuBoardContainer').classList.remove('hidden');
            document.getElementById('goBoardContainer').classList.add('hidden');
            initGomokuBoard();
          } else {
            document.getElementById('gomokuBoardContainer').classList.add('hidden');
            document.getElementById('goBoardContainer').classList.remove('hidden');
            initGoBoard();
          }
          
          if (msg.board) {
            for (let i = 0; i < (currentGameMode === 'gomoku' ? BOARD_SIZE_GOMOKU : BOARD_SIZE_GO); i++) {
              for (let j = 0; j < (currentGameMode === 'gomoku' ? BOARD_SIZE_GOMOKU : BOARD_SIZE_GO); j++) {
                if (msg.board[i] && msg.board[i][j] !== 0) {
                  const colorId = msg.board[i][j] - 1;
                  placePiece(i, j, colorId);
                }
              }
            }
          }
          
          updateGame();
          updateTurn();
          addSystemMessage('é‡è¿æˆåŠŸï¼');
          break;
          
        case 'restart':
          if (currentGameMode === 'gomoku') {
            initGomokuBoard();
          } else {
            initGoBoard();
          }
          currentTurn = 0;
          waitingReconnect = false;
          pendingOfflineOrderId = null;
          scores = gameConfig?.colors ? Array(gameConfig.colors).fill(0) : [0, 0];
          clearChat();
          document.getElementById('passBtn').style.display = currentGameMode === 'go' ? 'inline-block' : 'none';
          document.getElementById('passBtn').disabled = false;
          updateScoreBoard();
          updateTurn();
          addSystemMessage('æ¸¸æˆé‡æ–°å¼€å§‹ï¼');
          break;
          
        case 'rooms':
          renderRoomList(msg.rooms);
          break;
          
        case 'chat':
          addChatMessage(msg);
          break;
          
        case 'error':
          alert(msg.message);
          break;
      }
    }
    
    function switchScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }
    
    function clearChat() {
      document.getElementById('chatMessages').innerHTML = '';
    }
    
    function createRoom() {
      const playerName = document.getElementById('playerName').value.trim() || 'ç©å®¶1';
      safeSend({ type: 'create', playerName, gameMode: currentGameMode });
    }
    
    function joinRoom(roomId, gameMode) {
      let playerName = document.getElementById('playerName').value.trim();
      if (!playerName) {
        playerName = localStorage.getItem('gomoku_playerName') || 'ç©å®¶' + Date.now() % 1000;
      }
      const savedColorId = parseInt(localStorage.getItem('gomoku_colorId') || '0');
      safeSend({ type: 'join', roomId, playerName, colorId: savedColorId });
    }
    
    function joinByInput() {
      const input = document.getElementById('joinRoomInput');
      const roomId = input.value.trim().toUpperCase();
      if (roomId.length < 4) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„æˆ¿é—´å·');
        return;
      }
      let playerName = document.getElementById('playerName').value.trim();
      if (!playerName) {
        playerName = localStorage.getItem('gomoku_playerName') || 'ç©å®¶' + Date.now() % 1000;
      }
      const savedColorId = parseInt(localStorage.getItem('gomoku_colorId') || '0');
      safeSend({ type: 'join', roomId, playerName, colorId: savedColorId });
      input.value = '';
    }
    
    function selectColor(colorId) {
      if (players.some(p => p.colorId === colorId)) return;
      myColorId = colorId;
      localStorage.setItem('gomoku_colorId', colorId);
      safeSend({ type: 'selectColor', orderId: myOrderId, colorId });
    }
    
    function updatePlayerList() {
      const maxPlayers = gameConfig?.colors || 2;
      document.getElementById('playerCount').textContent = '(' + (players.length || 0) + '/' + maxPlayers + ')';
      const list = document.getElementById('playerList');
      list.innerHTML = (players || []).map((p, idx) => {
        const isOwner = p.orderId === ownerOrderId;
        const isMe = p.orderId === myOrderId;
        return '<div class="player-item">' +
          '<div class="player-order">' + (idx + 1) + '</div>' +
          '<div class="player-name">' + p.name + (isOwner ? ' ğŸ‘‘' : '') + (isMe ? ' (ä½ )' : '') + '</div>' +
          '<div class="player-color" style="background:' + p.color + '"></div></div>';
      }).join('');
      
      const startBtn = document.getElementById('startBtn');
      const minPlayers = gameConfig?.minPlayers || 2;
      if (myOrderId === ownerOrderId) {
        startBtn.style.display = 'block';
        startBtn.disabled = (players || []).length < minPlayers;
        startBtn.textContent = (players || []).length < minPlayers ? 'å¼€å§‹æ¸¸æˆ (è¿˜éœ€ ' + (minPlayers - (players || []).length) + ' äºº)' : 'å¼€å§‹æ¸¸æˆ';
      } else {
        startBtn.style.display = 'none';
      }
    }
    
    function updateColorPicker() {
      const takenColors = (players || []).map(p => p.colorId);
      const colors = currentGameMode === 'gomoku' ? PLAYER_COLORS_GOMOKU : PLAYER_COLORS_GO;
      const picker = document.getElementById('colorPicker');
      picker.innerHTML = colors.map((color, idx) => {
        const isTaken = takenColors.includes(idx);
        const isSelected = idx === myColorId;
        const action = isTaken ? '' : 'onclick="selectColor(' + idx + ')"';
        return '<div class="color-option ' + (isSelected ? 'selected' : '') + ' ' + (isTaken ? 'disabled' : '') + '" ' +
          'style="background:' + color + '" ' + action + '></div>';
      }).join('');
    }
    
    function updateScoreBoard() {
      const board = document.getElementById('scoreBoard');
      const colors = currentGameMode === 'gomoku' ? PLAYER_COLORS_GOMOKU : PLAYER_COLORS_GO;
      const roles = currentGameMode === 'gomoku' ? PLAYER_ROLES_GOMOKU : PLAYER_ROLES_GO;
      const winningScore = currentGameMode === 'gomoku' ? null : WINNING_SCORE_GO;
      
      board.innerHTML = colors.map((color, idx) => {
        const score = scores[idx] || 0;
        return '<div class="score-item">' +
          '<div class="score-color" style="background:' + color + '"></div>' +
          '<div class="score-value" id="score' + idx + '">' + score + '</div>' +
          (winningScore ? '<div class="score-target">/' + winningScore + '</div>' : '') +
          '</div>';
      }).join('');
    }
    
    function startGame() {
      safeSend({ type: 'start' });
    }
    
    function initGomokuBoard() {
      const board = document.getElementById('gomokuBoard');
      board.innerHTML = '';
      for (let i = 0; i < BOARD_SIZE_GOMOKU; i++) {
        for (let j = 0; j < BOARD_SIZE_GOMOKU; j++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = i;
          cell.dataset.col = j;
          cell.onclick = () => makeMove(i, j);
          board.appendChild(cell);
        }
      }
    }
    
    function initGoBoard() {
      const board = document.getElementById('goBoard');
      board.innerHTML = '';
      for (let i = 0; i < BOARD_SIZE_GO; i++) {
        for (let j = 0; j < BOARD_SIZE_GO; j++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          if ((i === 3 || i === 5) && (j === 3 || j === 5) || (i === 4 && j === 4)) {
            cell.classList.add('star');
          }
          cell.dataset.row = i;
          cell.dataset.col = j;
          cell.onclick = () => makeMove(i, j);
          board.appendChild(cell);
        }
      }
    }
    
    function makeMove(row, col) {
      if (currentTurn !== myOrderId) return;
      if (waitingReconnect) return;
      const boardEl = currentGameMode === 'gomoku' ? document.getElementById('gomokuBoard') : document.getElementById('goBoard');
      const cell = boardEl.querySelector('.cell[data-row="' + row + '"][data-col="' + col + '"]');
      if (cell && cell.querySelector('.piece')) return;
      safeSend({ type: 'move', orderId: myOrderId, row, col });
    }
    
    function passTurn() {
      if (currentTurn !== myOrderId) return;
      safeSend({ type: 'pass', orderId: myOrderId });
    }
    
    function placePiece(row, col, colorId) {
      const boardEl = currentGameMode === 'gomoku' ? document.getElementById('gomokuBoard') : document.getElementById('goBoard');
      const cell = boardEl.querySelector('.cell[data-row="' + row + '"][data-col="' + col + '"]');
      if (cell && !cell.querySelector('.piece')) {
        const piece = document.createElement('div');
        piece.className = 'piece ' + (currentGameMode === 'gomoku' ? PIECE_CLASSES_GOMOKU[colorId] : PIECE_CLASSES_GO[colorId]);
        cell.appendChild(piece);
      }
    }
    
    function updateGame() {
      const me = (players || []).find(p => p.orderId === myOrderId);
      if (me) {
        document.getElementById('myPieceColor').style.background = me.color;
        document.getElementById('myPieceName').textContent = me.role;
        document.getElementById('myScore').textContent = me.score ?? 0;
      }
      updateTurn();
    }
    
    function updateTurn() {
      const turnIndicator = document.getElementById('currentTurn');
      
      if (waitingReconnect) {
        turnIndicator.className = 'turn-indicator paused';
        turnIndicator.innerHTML = 'â¸ ç­‰å¾…æˆ¿ä¸»å¤„ç†...';
        document.getElementById('passBtn').disabled = true;
        return;
      }
      
      if (currentTurn === null) {
        turnIndicator.className = 'turn-indicator waiting';
        turnIndicator.innerHTML = 'æ¸¸æˆç»“æŸ';
        return;
      }
      
      const player = (players || []).find(p => p.orderId === currentTurn);
      
      if (player) {
        const isMyTurn = player.orderId === myOrderId;
        turnIndicator.className = isMyTurn ? 'turn-indicator' : 'turn-indicator waiting';
        turnIndicator.innerHTML = isMyTurn 
          ? 'è½®åˆ°ä½ äº†ï¼(' + player.role + ')'
          : 'ç­‰å¾… ' + player.name + ' ä¸‹æ£‹ (' + player.role + ')';
        document.getElementById('passBtn').disabled = !isMyTurn;
      } else {
        turnIndicator.className = 'turn-indicator waiting';
        turnIndicator.innerHTML = 'ç­‰å¾…æ¸¸æˆä¸­...';
        document.getElementById('passBtn').disabled = true;
      }
    }
    
    function showWinner(winnerOrderId) {
      const winner = (players || []).find(p => p.orderId === winnerOrderId);
      document.getElementById('winnerInfo').innerHTML = '<p style="font-size:24px;margin-bottom:10px;">ğŸ† ' + (winner ? winner.name : 'æœªçŸ¥') + ' è·èƒœï¼</p><p>(' + (winner ? winner.role : '') + ')</p>';
      document.getElementById('winnerModal').style.display = 'flex';
    }
    
    function restartGame() {
      closeModal();
      safeSend({ type: 'restart' });
    }
    
    function closeModal() {
      document.getElementById('winnerModal').style.display = 'none';
    }
    
    function leaveCurrentRoom() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'leave' }));
      }
      currentRoomId = null;
      myOrderId = null;
      ownerOrderId = 0;
      players = [];
      scores = [];
      waitingReconnect = false;
      pendingOfflineOrderId = null;
      gameConfig = null;
      switchScreen('selectScreen');
      document.getElementById('homeSidebar').style.display = 'block';
      document.getElementById('gameSidebar').style.display = 'none';
      document.getElementById('passBtn').style.display = 'none';
      refreshRoomList();
    }
    
    function leaveGameToHome() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'leave' }));
      }
      currentRoomId = null;
      myOrderId = null;
      ownerOrderId = 0;
      players = [];
      scores = [];
      waitingReconnect = false;
      pendingOfflineOrderId = null;
      gameConfig = null;
      switchScreen('selectScreen');
      document.getElementById('homeSidebar').style.display = 'block';
      document.getElementById('gameSidebar').style.display = 'none';
      document.getElementById('passBtn').style.display = 'none';
      refreshRoomList();
    }
    
    function refreshRoomList() {
      safeSend({ type: 'getRooms' });
    }
    
    function renderRoomList(rooms) {
      const list = document.getElementById('roomList');
      if (!rooms || rooms.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— æˆ¿é—´</div>';
        return;
      }
      list.innerHTML = rooms.map(r => 
        '<div class="room-item" onclick="joinRoom(\'' + r.id + '\')">' +
          '<div>' +
            '<div class="room-id">' + r.id + '</div>' +
            '<div class="room-count">' + r.playerCount + ' äºº</div>' +
          '</div>' +
          '<span class="room-game ' + r.gameMode + '">' + (r.gameMode === 'gomoku' ? 'äº”å­æ£‹' : 'å›´æ£‹') + '</span>' +
        '</div>'
      ).join('');
    }
    
    function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      safeSend({ type: 'chat', message });
      input.value = '';
    }
    
    function addChatMessage(msg) {
      const container = document.getElementById('chatMessages');
      const player = (players || []).find(p => p.orderId === msg.orderId);
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.innerHTML = '<div class="chat-header"><span class="chat-color-dot" style="background:' + (player ? player.color : '#999') + '"></span><span>' + (msg.playerName || 'ç©å®¶') + '</span></div><div>' + msg.message + '</div>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
    
    function addSystemMessage(message) {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-message system';
      div.textContent = message;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
    
    // æ‰‹æœºç«¯åå°æ£€æµ‹
    let isInBackground = false;
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // è¿›å…¥åå°ï¼Œè‡ªåŠ¨ç¦»å¼€æˆ¿é—´
        isInBackground = true;
        if (currentRoomId && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'leave' }));
          console.log('é¡µé¢è¿›å…¥åå°ï¼Œè‡ªåŠ¨ç¦»å¼€æˆ¿é—´');
        }
      } else {
        // åˆ‡å›å‰å°ï¼Œé‡æ–°è¿æ¥
        if (isInBackground && currentRoomId) {
          console.log('é¡µé¢åˆ‡å›å‰å°ï¼Œå°è¯•é‡è¿');
          if (ws && ws.readyState === WebSocket.OPEN) {
            // é‡æ–°åŠ å…¥æˆ¿é—´
            let playerName = localStorage.getItem('gomoku_playerName') || 'ç©å®¶' + Date.now() % 1000;
            ws.send(JSON.stringify({ 
              type: 'join', 
              roomId: currentRoomId, 
              playerName: playerName,
              colorId: parseInt(localStorage.getItem('gomoku_colorId') || '0')
            }));
          }
        }
        isInBackground = false;
      }
    });

    window.onload = function() {
      connect();
      initGomokuBoard();
      initGoBoard();
      setInterval(refreshRoomList, 10000);
    };
  </script>
</body>
</html>
